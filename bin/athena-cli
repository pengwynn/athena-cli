#!/usr/bin/env jruby
#
require 'gli'
require 'amazon_athena'

def athena
  AmazonAthena::Client.new
end

include GLI::App

program_desc 'CLI for Amazon Athena'

version AmazonAthena::VERSION

subcommand_option_handling :normal
arguments :strict

desc 'Check for required AWS setup.'
command :doctor do |c|
  c.action do |global_options,options,args|
    if access_key.nil? || access_secret.nil?
      exit_now! "Please configure AWS credentials."
    end

    if staging_folder.nil?
      exit_now! "Please configure S3 staging folder."
    end

    unless class_path =~ /AthenaJDBC/
      exit_now! "Could not locate Athena JDBC driver."
    end

    puts "Good to go!"
  end
end

desc 'Manage Athena databases'
command :database do |c|
  c.desc "List databases"
  c.command :list do |add|
    add.action do |global_options,options,args|
      puts athena.databases
    end
  end
end

desc 'Manage tables in Athena databases'
command :table do |c|
  c.desc "Describe a table"
  c.arg_name "database.table"
  c.command :describe do |add|
    add.action do |global_options,options,args|
      puts athena.table_describe(args.first)
    end
  end

  c.desc "List tables in a database"
  c.arg_name "database.table"
  c.command :list do |add|
    add.action do |global_options,options,args|
      puts athena.tables(args.first)
    end
  end

  c.desc "Show table properties"
  c.arg_name "database.table"
  c.command :properties do |add|
    add.action do |global_options,options,args|
      data = athena.table_properties(args.first)

      table(data)
    end
  end

  c.desc "Show table create DDL"
  c.arg_name "database.table"
  c.command :show do |add|
    add.action do |global_options,options,args|
      puts athena.table_show_create(args.first)
    end
  end

  c.desc "Refresh table partitions"
  c.arg_name "database.table"
  c.command :repair do |add|
    add.action do |global_options,options,args|
      puts athena.table_repair(args.first)
    end
  end

  c.desc "Drop table"
  c.arg_name "database.table"
  c.command :drop do |add|
    add.action do |global_options,options,args|
      puts athena.table_drop(args.first)
    end
  end
end

desc 'Manage partitions in Athena database tables'
command :partition do |c|
  c.desc "List partitions in a table"
  c.arg_name "database.table"
  c.command :list do |add|
    add.action do |global_options,options,args|
      puts athena.partitions(args.first)
    end
  end

  c.desc "Drop partitions in a table"
  c.arg "database.table"
  c.arg "key=value,key=value:key=value,key=value"
  c.command :drop do |add|
    add.action do |global_options,options,args|
      puts athena.partitions_drop(*args)
    end
  end
end

pre do |global,command,options,args|
  check_class_path
  true
end

post do |global,command,options,args|
  # Post logic here
  # Use skips_post before a command to skip this
  # block on that command only
end

on_error do |exception|
  # Error logic here
  # return false to skip default error handling
  true
end

def access_key
  ENV['AWS_ACCESS_KEY']
end

def access_secret
  ENV['AWS_SECRET_KEY']
end

def staging_folder
  ENV['ATHENA_S3_STAGING_DIR']
end

def class_path
  ENV['CLASSPATH']
end

def check_class_path
  unless class_path =~ /AthenaJDBC/
    jar_path =  File.expand_path(File.join([File.dirname(__FILE__),'..', 'jdbc','AthenaJDBC41-1.0.0.jar']))
    msg = <<~MSG
    JRuby requires JDBC driver to be in your Java class path.
    For download instructions, see:

        http://docs.aws.amazon.com/athena/latest/ug/connect-with-jdbc.html

    After downloading, add /path/to/driver.jar to your CLASSPATH environment variable.

    Example:

        export CLASSPATH="$CLASSPATH:~/src/AthenaJDB41-1.0.0.jar"
    MSG
    exit_now! msg
  end
end

def table(data)
  longest_key = data.keys.max_by(&:length)
  data.each do |key, value|
    printf "%##{longest_key.length}s %s\n", key, value
  end
end

exit run(ARGV)
